# infra-observability — Library Usage Audit

**Upstream Library:** structlog >=24.0, opentelemetry-api/sdk >=1.20
**RAG Status:** AMBER
**Checklist:** 9/12 passed

## Findings

| ID | Severity | Checklist | Description | File:Line | Recommendation |
|----|----------|-----------|-------------|-----------|----------------|
| OB-1 | - | PASS | `configure_logging()` is called once in the lifespan hook (`_observability_lifespan`). `cache_logger_on_first_use=True` prevents reconfiguration. | `packages/infra-observability/src/praecepta/infra/observability/__init__.py:32` | - |
| OB-2 | - | PASS | `structlog.contextvars.merge_contextvars` is used in the processor chain. Middleware uses `structlog.contextvars.bind_contextvars` and `unbind_contextvars`. No thread-local or global dict patterns found. | `packages/infra-observability/src/praecepta/infra/observability/logging.py:242`, `middleware.py:79,89` | - |
| OB-3 | - | PASS | OTLP exporter is supported and lazily imported when `exporter_type="otlp"`. Console exporter is only used when explicitly selected. Default is `"none"` (disabled), so console is never used in production unless misconfigured. | `packages/infra-observability/src/praecepta/infra/observability/tracing.py:200-228` | - |
| OB-4 | LOW | PASS | OpenTelemetry SDK uses W3C TraceContext propagation by default when `FastAPIInstrumentor.instrument_app()` is called. No explicit override disabling it. However, there is no explicit propagator configuration, relying entirely on SDK defaults. | `packages/infra-observability/src/praecepta/infra/observability/tracing.py:290-294` | Consider explicitly setting `set_global_textmap(TraceContextTextMapPropagator())` to make the W3C format choice visible and resilient to SDK default changes. |
| OB-5 | - | PASS | `traced_operation` decorator accepts a descriptive `name` parameter (e.g., `"event_store.append"`). `start_span` context manager follows the same pattern. Naming follows dotted-lowercase convention consistent with OTel semantic conventions. | `packages/infra-observability/src/praecepta/infra/observability/instrumentation.py:97-171,174-213` | - |
| OB-6 | - | PASS | `shutdown_tracing()` calls `_tracer_provider.shutdown()` which flushes pending spans via `BatchSpanProcessor.shutdown()`. Called in lifespan teardown after `yield`. Idempotent (checks for `None`). | `packages/infra-observability/src/praecepta/infra/observability/tracing.py:297-314`, `__init__.py:35` | - |
| OB-7 | - | PASS | `LOG_LEVEL` environment variable is read via `LoggingSettings` (pydantic-settings) with validation against known levels. Default is `"INFO"`. | `packages/infra-observability/src/praecepta/infra/observability/logging.py:82-85,108-126` | - |
| OB-8 | HIGH | FAIL | No sampler configuration exists. `TracerProvider` is constructed without a `sampler` argument, which defaults to `ALWAYS_ON` (100% sampling). There is no `OTEL_TRACES_SAMPLER` or `sample_rate` setting in `TracingSettings`. In production with OTLP export, this will capture every trace, causing significant overhead and cost. | `packages/infra-observability/src/praecepta/infra/observability/tracing.py:276` | Add a `sample_rate: float` field to `TracingSettings` (env var `OTEL_TRACES_SAMPLE_RATE`, default 1.0) and pass `TraceIdRatioBasedSampler(sample_rate)` to `TracerProvider(resource=resource, sampler=sampler)`. |
| OB-9 | - | PASS | `service.name` and `service.version` are set in the `Resource` via `TracingSettings.service_name` / `service_version`, configurable via `OTEL_SERVICE_NAME` and `OTEL_SERVICE_VERSION` env vars. | `packages/infra-observability/src/praecepta/infra/observability/tracing.py:268-273` | - |
| OB-10 | MEDIUM | FAIL | The middleware binds `trace_id` and `span_id` to structlog context, but does NOT bind `request_id`. The docstrings claim correlation with `RequestIdMiddleware`, but the observability package has no runtime dependency on `infra-fastapi` and never reads or binds the request ID. The `request_id` only appears in structlog output if `RequestIdMiddleware` independently binds it via `structlog.contextvars` — which it does. However, the observability package itself does not ensure or verify this integration; it is a convention-gap dependency. | `packages/infra-observability/src/praecepta/infra/observability/middleware.py:37-38,79-82` | Document the implicit coupling explicitly. Consider adding `request_id` to the `unbind_contextvars` call in `TraceContextMiddleware` or verifying its presence. At minimum, the docstring claim of "automatic correlation ID binding" in `logging.py:6` should clarify this is provided by a separate package. |
| OB-11 | MEDIUM | FAIL | `TraceContextMiddleware` has `priority=20`. `RequestIdMiddleware` has `priority=10`. In Starlette, middleware added first wraps outermost. If auto-discovery sorts by ascending priority, `RequestIdMiddleware` (10) executes outermost, then `TraceContextMiddleware` (20). This means trace context is bound AFTER request ID, which is correct for the stated goal. However, the `TraceContextMiddleware` docstring says it must be "AFTER RequestIdMiddleware" which is ambiguous — in Starlette's LIFO middleware model, "after" in `add_middleware` means "inner". The priority=20 for trace context is NOT outermost; the comment `# Outermost band (0-99)` on line 95 is misleading. For OTel instrumentation to capture the full request lifecycle (including request ID assignment), the trace context middleware should be outermost (lowest priority). | `packages/infra-observability/src/praecepta/infra/observability/middleware.py:93-96` | If trace context should wrap the entire request (outermost), set `priority=5` (lower than RequestIdMiddleware's 10). If the current ordering is intentional (trace context inner to request ID), update the comment from "Outermost band" to "Inner to RequestIdMiddleware" to avoid confusion. |
| OB-12 | - | PASS | `LoggingSettings.use_json_logs` returns `True` only for `environment == "production"`, selecting `JSONRenderer`. All other environments use `ConsoleRenderer(colors=True)` for human-readable output. | `packages/infra-observability/src/praecepta/infra/observability/logging.py:128-135,252-255` | - |

## Narrative

The `infra-observability` package demonstrates solid structlog and OpenTelemetry usage overall. The structlog configuration is clean: a single `configure_logging()` call at startup, proper use of `contextvars` for request-scoped context, environment-aware renderer selection (JSON vs console), and a thoughtful sensitive-data redaction processor. The OpenTelemetry setup correctly uses `BatchSpanProcessor`, lazy-imports optional exporters (OTLP, Jaeger), sets service resource attributes from environment variables, and provides a clean shutdown path.

Three issues warrant attention:

1. **Missing sampler configuration (OB-8, HIGH):** The `TracerProvider` is created without a sampler, defaulting to `ALWAYS_ON`. This is the most impactful finding — in production with OTLP export enabled, every request generates a trace, which can cause significant overhead and backend cost. Adding a configurable `TraceIdRatioBasedSampler` is straightforward and essential before production deployment.

2. **Request ID integration is implicit (OB-10, MEDIUM):** The package documents correlation with `RequestIdMiddleware` but relies on a convention-gap dependency — the request ID appears in logs only because `RequestIdMiddleware` in `infra-fastapi` independently binds it to `structlog.contextvars`. This is the "incorrect wiring via convention gaps" anti-pattern identified in the projection remediation. The coupling works but is fragile and undocumented at the code level.

3. **Middleware priority semantics are confusing (OB-11, MEDIUM):** The `priority=20` with comment "Outermost band" is misleading. Whether this is actually a bug depends on the auto-discovery sorting logic, but the comment does not match the numeric relationship with `RequestIdMiddleware`'s `priority=10`. This should be clarified to prevent future misordering.

No critical issues (data loss, security, outage) were found. The Jaeger exporter reference (`opentelemetry.exporter.jaeger.thrift`) is deprecated in newer OTel SDK versions and may be removed in a future release, but this is a low-priority concern since the import is guarded by a try/except.
