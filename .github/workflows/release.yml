name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type (auto = determine from commits)"
        required: true
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
      generate_blog_post:
        description: "Generate release blog post for docs site"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # ── Gate: full quality suite must pass first ──────────────────────
  quality:
    uses: ./.github/workflows/quality.yml

  # ── Bump version, generate changelog, push tag ───────────────────
  release:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version and generate changelog
        id: bump
        run: |
          BUMP_ARG=""
          if [ "${{ inputs.bump }}" != "auto" ]; then
            BUMP_ARG="--${{ inputs.bump }}"
          fi
          if uv run cz bump $BUMP_ARG --changelog --changelog-to-stdout > body.md 2>&1; then
            echo "bumped=true" >> "$GITHUB_OUTPUT"
          else
            if [ "${{ inputs.bump }}" = "auto" ]; then
              echo "::notice::No bump-eligible commits found since last tag (only feat/fix/breaking trigger auto bumps). Skipping release."
              echo "bumped=false" >> "$GITHUB_OUTPUT"
            else
              echo "::error::cz bump --${{ inputs.bump }} failed"
              exit 1
            fi
          fi

      - name: Get new version
        if: steps.bump.outputs.bumped == 'true'
        id: version
        run: |
          VERSION=$(uv run cz version --project)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"
          echo "Released version: $VERSION"

      - name: Generate release blog post
        if: steps.bump.outputs.bumped == 'true' && inputs.generate_blog_post
        run: |
          mkdir -p docs/docs/releases
          RELEASE_DATE=$(date +%Y-%m-%d)
          VERSION="${{ steps.version.outputs.version }}"

          {
            echo "---"
            echo "date: $RELEASE_DATE"
            echo "---"
            echo ""
            echo "# Praecepta v${VERSION}"
            echo ""
            cat body.md
            echo ""
            echo "---"
            echo ""
            echo "*Full changelog: [CHANGELOG.md](https://github.com/wet-ink-corporation/praecepta/blob/main/CHANGELOG.md)*"
          } > "docs/docs/releases/v${VERSION}.md"

          git add docs/docs/releases/
          git commit --amend --no-edit

          # Re-tag since amend changed the commit hash
          git tag -f "v${VERSION}" -m "Release v${VERSION}"

      - name: Push release
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git push origin main --follow-tags

      - name: Upload release notes artifact
        if: steps.bump.outputs.bumped == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: body.md
